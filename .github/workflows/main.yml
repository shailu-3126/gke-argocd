name: CI (Keyless) — Build & Deploy Frontend (safe build)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure WIF metadata is present (fast warn if missing)
        run: |
          if [ -z "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}" ]; then
            echo "::warning::GCP_WORKLOAD_IDENTITY_PROVIDER secret not found; attempting hardcoded fallback..."
          fi
          if [ -z "${{ secrets.GCP_SA_EMAIL }}" ]; then
            echo "::warning::GCP_SA_EMAIL secret not found; attempting hardcoded fallback..."
          fi

      - name: Authenticate to Google Cloud (keyless - Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          # prefer secrets; fallback to literal strings if secrets not provided
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER || 'projects/619930646601/locations/global/workloadIdentityPools/github-pool/providers/github-provider' }}
          service_account: ${{ secrets.GCP_SA_EMAIL || 'ci-deployer@shailaja-477403.iam.gserviceaccount.com' }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: shailaja-477403

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Prepare build context (create Dockerfile if missing)
        run: |
          CONTEXT_DIR="."
          echo "Using build context: $CONTEXT_DIR"

          if [ ! -f "${CONTEXT_DIR}/Dockerfile" ]; then
            echo "No Dockerfile found — creating a minimal Dockerfile and index.html"

            # Create index.html (use single-quoted EOF to avoid shell expansion)
            cat > ${CONTEXT_DIR}/index.html <<'HTML_EOF'
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Frontend Test</title></head>
<body>
  <h1>Frontend deployed via GKE + Argo CD</h1>
  <p>Built by GitHub Actions run: $GITHUB_RUN_ID</p>
</body>
</html>
HTML_EOF

            # Create Dockerfile
            cat > ${CONTEXT_DIR}/Dockerfile <<'DOCKER_EOF'
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 80
DOCKER_EOF
          else
            echo "Dockerfile exists — using repo files."
          fi

          ls -la ${CONTEXT_DIR}

      - name: Build & Push Docker image
        id: build
        env:
          IMAGE_BASE: "us-central1-docker.pkg.dev/shailaja-477403/frontend-repo/frontend"
        run: |
          TAG="$(date +%s)"
          IMAGE="${IMAGE_BASE}:github-${TAG}"
          echo "IMAGE_URI=${IMAGE}" >> $GITHUB_ENV
          echo "Building image: $IMAGE"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Update GitOps repo (gke-argocd)
        env:
          GITOPS_REPO: "https://github.com/shailu-3126/gke-argocd.git"
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          if [ -d "./apps/frontend" ]; then
            echo "Updating apps/frontend/deployment.yaml in current repo"
            sed -i "s|image: .*|image: ${IMAGE_URI}|g" apps/frontend/deployment.yaml || echo "No change needed or file missing"
            git add apps/frontend/deployment.yaml || true
            git commit -m "ci: update frontend image to ${IMAGE_URI}" || echo "no changes to commit"
            git push origin main || echo "push failed (maybe no permission); please push manually"
          else
            git clone ${GITOPS_REPO} gitops
            cd gitops/apps/frontend || (echo "target path missing" && exit 0)
            sed -i "s|image: .*|image: ${IMAGE_URI}|g" deployment.yaml || true
            git add deployment.yaml
            git commit -m "ci: update frontend image to ${IMAGE_URI}" || echo "no changes"
            git push origin main || echo "push failed"
          fi
